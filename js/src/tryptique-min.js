(function(){var a=Backbone.Model.extend({url:"php/config",defaults:function(){return{entitiesURL:null}},fetch:function(c,b){(b)||(b={});_.extend(b,{parse:true,dataType:"text",url:this.url+"/"+c.name+"/"+c.id});kps.ConfigModel.__super__.fetch.call(this,b)},parse:function(b,c){var d=$($.parseXML(b));var e={entitiesURL:d.find("json_path").text()};return e}});window.kps=window.kps||{};window.kps.ConfigModel=window.kps.ConfigModel||a})();(function(){var a=Backbone.Collection.extend({url:"php/entities",model:kps.EntityModel,_localizationDefaults:{},_mapDefaults:{},initialize:function(){(this.model)||(this.model=kps.EntityModel)},fetch:function(c,b){(b)||(b={});_.extend(b,{parse:true,reset:true,dataType:"json",url:this.url+"?source="+encodeURIComponent(c)});kps.EntityCollection.__super__.fetch.call(this,b)},parse:function(b,c){(b)||(b={});var d=b.events?b.events.slice():null;_.extend(this._localizationDefaults,b.localisation);_.extend(this._mapDefaults,b.map);this._mapDefaults.maxaffcity=b.maxaffcity;return d},calculateDelta:function(b){_.each(this.models,function(c){c.set("delta",kps.Utils.calculateDelta(b,c.toJSON()))},this);this.comparator="delta";this.sort()}});window.kps=window.kps||{};window.kps.EntityCollection=window.kps.EntityCollection||a})();(function(){var a=Backbone.Model.extend({KEY_MAPPIMG:{n:"name",a:"address",c:"country",z:"zipCode",lat:"latitude","long":"longitude"},defaults:function(){return{name:"",adress:"",country:"",zipCode:"",latitude:0,longitude:0,geometry:null}},parse:function(b,c){(b)||(b={});var e={};for(var d in this.KEY_MAPPIMG){if(b[d]){e[this.KEY_MAPPIMG[d]]=b[d]}}e.geometry={type:"Point",coordinates:[b["long"],b.lat]};return e}});window.kps=window.kps||{};window.kps.EntityModel=window.kps.EntityModel||a})();(function(){var a=Backbone.Model.extend({url:"php/localization",defaults:function(){return{timeZone:null,country:null,countryCode:null,region:null,regionCode:null,areaCode:0,city:null,zipCode:null,latitude:0,longitude:0,metroCode:0,dmaCode:0}},fetch:function(b){(b)||(b={});_.extend(b,{url:this.url,parse:true,dataType:"text"});kps.LocalizationModel.__super__.fetch.call(this,b)},fetchByZipCode:function(c,b){(b)||(b={});_.extend(b,{parse:true,dataType:"text",url:this.url+"/"+c});kps.LocalizationModel.__super__.fetch.call(this,b)},parse:function(b,c){var d=$($.parseXML(b));var e={timeZone:d.find("time_zone").text(),country:d.find("country").text(),countryCode:d.find("countrycode").text(),region:d.find("region").text(),regionCode:d.find("regioncode").text(),areaCode:parseInt(d.find("areacode").text()),city:d.find("city").text(),zipCode:d.find("postalcode").text(),latitude:parseFloat(d.find("latitude").text()),longitude:parseFloat(d.find("longitude").text()),metroCode:parseInt(d.find("metro_code").text()),dmaCode:parseInt(d.find("dma_code").text())};return e}});window.kps=window.kps||{};window.kps.LocalizationModel=window.kps.LocalizationModel||a})();(function(){var a=Backbone.Router.extend({_configModel:null,_entityList:null,_localizationModel:null,_ctaView:null,_videoView:null,_localizationView:null,_mapView:null,initialize:function(){if(window.tryptique_params){this._configModel=new kps.ConfigModel();this._configModel.on("change",_.bind(this.onConfigChange,this));this._configModel.fetch(tryptique_params)}},onConfigChange:function(){this._ctaView=new kps.CallToActionView({model:this._configModel}).render();this._videoView=new kps.VideoContainerView({model:this._configModel}).render();this._entityList=new kps.EntityCollection();this._entityList.on("reset",_.bind(this.onEntitiesChange,this));this._entityList.fetch(this._configModel.get("entitiesURL"))},onEntitiesChange:function(){this._localizationModel=new kps.LocalizationModel();this._localizationView=new kps.LocalizationFormView({model:this._localizationModel}).render();this._mapView=new kps.MapContainerView({collection:this._entityList}).render();this._localizationModel.on("change",_.bind(this.onLocalizationChange,this));this._localizationModel.fetch()},onLocalizationChange:function(){this._entityList.calculateDelta(this._localizationModel.toJSON())}});window.kps=window.kps||{};window.kps.Tryptique=window.kps.Tryptique||a;$(document).ready(function(){kps.Utils.loadTemplates(["CallToActionView","VideoContainerView","LocalizationFormView","MapContainerView","MarkerView"],kps,function(){kps.app=new kps.Tryptique();Backbone.history.start()})})})();(function(){var a={EARTH_RADIUS:6378,loadTemplates:function(b,c,e){var d=[];$.each(b,function(g,f){if(c[f]){d.push($.get("tpl/"+f+".html",function(h){c[f].prototype.template=_.template(h)}))}});$.when.apply(null,d).done(e)},calculateDelta:function(h,g){var f=h.latitude*Math.PI/180;var e=g.latitude*Math.PI/180;var j=h.longitude*Math.PI/180;var i=g.longitude*Math.PI/180;return kps.Utils.EARTH_RADIUS*Math.acos(Math.sin(f)*Math.sin(e)+Math.cos(f)*Math.cos(e)*Math.cos(j-i))}};window.kps=window.kps||{};window.kps.Utils=window.kps.Utils||a})();(function(){var a=Backbone.View.extend({el:$("#cta").first(),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});window.kps=window.kps||{};window.kps.CallToActionView=window.kps.CallToActionView||a})();(function(){var a=Backbone.View.extend({el:$("#localization_form").first(),render:function(){this.$el.html(this.template());return this}});window.kps=window.kps||{};window.kps.LocalizationFormView=window.kps.LocalizationFormView||a})();(function(){var b=Backbone.View.extend({el:$("#map_container").first(),events:{"click .icon_fullpage":"toggleFullscreen"},_map:null,initialize:function(){this.collection.on("sort",_.bind(this.onCollectionSorted,this))},render:function(){this.$el.html(this.template());var e=new MM.TemplatedLayer("http://tile.openstreetmap.org/{Z}/{X}/{Y}.png");var d=new MM.MarkerLayer();this._map=new MM.Map(this.el.id,e);this._map.addLayer(d);_.each(this.collection.models,function(f){d.addMarker(new kps.MarkerView({model:f}).render().el,f.toJSON())},this);return this},toggleFullscreen:function(){if($("div.visuel_map").hasClass("visu1")){a()}else{c()}this._map._windowResize()},onCollectionSorted:function(){var e=[];var d=null;_.times(this.collection._mapDefaults.maxaffcity,function(f){d=this.collection.at(f);e.push(new MM.Location(d.get("latitude"),d.get("longitude")))},this);this._map.setExtent(e);this._map.setZoom(this.collection._mapDefaults.zoom)}});window.kps=window.kps||{};window.kps.MapContainerView=window.kps.MapContainerView||b;function c(){$("div.visuel_client").css("display","none");$("div.visuel_video").css("display","none");$("div.visuel_form").addClass("visu2");$("div.visuel_map").addClass("visu1")}function a(){$("div.visuel_client").css("display","block");$("div.visuel_video").css("display","block");$("div.visuel_form").removeClass("visu2");$("div.visuel_map").removeClass("visu1")}})();(function(){var a=Backbone.View.extend({tagName:"a",className:"marker",render:function(){this.$el.html(this.template());return this}});window.kps=window.kps||{};window.kps.MarkerView=window.kps.MarkerView||a})();(function(){var a=Backbone.View.extend({el:$("#video_container").first(),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});window.kps=window.kps||{};window.kps.VideoContainerView=window.kps.VideoContainerView||a})();